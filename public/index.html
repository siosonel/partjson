<!DOCTYPE html>
<html>
<head>
	<title>Parjson</title>
	<meta charset="utf-8">
	<link rel="shortcut icon" href="">
	<style>
	html {
	  height: 100vh;
	}

	body {
		height: 100vh;
		display: flex;
		flex-direction: column;
  	align-items: stretch;
		font-family: arial, helvetica, sans serif;
	}

	flex-fill {
	  flex: 1 1 auto;
	}

	h1, h3 {
		margin: 0.25rem;
		text-align: center;
	}

	.nav-top {
		width: 100%;
	}

	.nav-banner {
		padding: 5px;
    background: #333;
    color: #99cc00;
    overflow: hidden;
	}

	.nav-bar {
		min-height:16px;
    padding: 2px;
    text-align: center;
    background: #333;
    color: #99cc00;
    overflow: hidden;
	}

	.nav-col {
		display: inline-block;
		padding: 5px;
    vertical-align: top;
		text-align: center;
	}

	.nav-tab {
		padding: 2px;
		text-align: center;
    background: #333;
    cursor: pointer;
	}

	.nav-symbol {
		height: 0;
		padding: 0;
    width: 100%;
		text-align: center;
    background: #333;
    cursor: pointer;
    overflow: hidden;
    transition: height ease 0.1s, padding ease 0.1s;
  }

  .nav-tab:hover, .nav-symbol:hover {
  	color: #ff0;
  	background: #999;
  }

  content {
  	flex: 1;
  }

	.section-title {
		margin: 30px 0 16px 4%; 
		text-align: left;
	}

	.example-div {
 		width: 90%;
    margin: auto;
    margin-bottom: 40px;
    background: #ececec;
    padding: 10px;
  }

  .example-title {
  	margin: 0 0 0 4%; 
  	font-style: italic;
  }

	.jsondiv {
		display: inline-block; 
		height: 20vh;
		width: 45%;
		margin: 10px;
		white-space: nowrap;
	}

	.inputlabel {
		color: #777;
	 	text-decoration: underline; 
	 	cursor: pointer;
	}

	.inputtext {
		width:100%; 
		height:100%;
    background: #333;
    color: #99cc00;
    white-space: pre;
	}

	.tsv {
		display: none;
		width: 92%; 
		height: 10vh;
		margin: 0 4%;
    background: #333;
    color: #ff9900;
		white-space: pre;
	}

	.btn-div {
		margin: auto;
		text-align: center;
	}
	</style>
	<script src="test.js"></script>
	<script src="/parjson/public/example.js" charset="utf-8"></script>
	<script src="/parjson/src/Parjson.js" charset="utf-8"></script>
	<script src="/parjson/src/KeyFiller.js" charset="utf-8"></script>
	<script src="/parjson/src/ValueFiller.js" charset="utf-8"></script>
	<script src="/parjson/src/Err.js" charset="utf-8"></script>
</head>
<body>

<div class='nav-top'>
	<div class="nav-banner">
		<div style="float:left; padding: 0 12px; font-size: 24px;">ParJSON</div>
	</div>
	<nav class="nav-bar" 
		onmouseenter="expandSymbols()" 
		onmouseleave="collapseSymbols()">
		<div style="width: 100%; min-height: 16px; white-space: nowrap;">
			<div class="nav-col" id="nav-col-skip">
				<div class="nav-tab"> [ skip ] </div>
			</div>
			<div class="nav-col" id="nav-col-time">
				<div class="nav-tab"> [ timing ] </div>
			</div>
			<div class="nav-col" id="nav-col-aggr">
				<div class="nav-tab"> [ aggregation ] </div>
			</div>
			<div class="nav-col" id="nav-col-subs">
				<div class="nav-tab"> [ substitution ] </div>
			</div>
			<div class="nav-col" id="nav-col-stem">
				<div class="nav-tab">  stem  </div>
			</div>
			<div class="nav-col" id="nav-col-conv">
				<div class="nav-tab"> [ conversion ] </div>
			</div>
		</div>
	</nav>
</div>

<content>
	<section id='quick-examples'>
		<h3 class='section-title'>Quick Examples</h3>
	</section>
	<hr>

	<section id='stem'>
		<h3 class='section-title'>Stem words</h3>
	</section>
	<hr>

	<section id='substitution'>
		<h3 class='section-title'>Substitution</h3>
	</section>
	<hr>

	<section id='conversion'>
		<h3 class='section-title'>Conversion</h3>
	</section>
	<hr>

	<section id='aggregation'>
		<h3 class='section-title'>Aggregation</h3>
	</section>
	<hr>

	<section id='timing'>
		<h3 class='section-title'>Timing</h3>
	</section>
	<hr>

	<section id='skip'>
		<h3 class='section-title'>Skip</h3>
	</section>
	<hr>
</content>

<template id='emptyExample'>
	<div class="example-div">
		<h4 id="" class="example-title"></h4>
		<div style="text-align: center">
			<div class='jsondiv'>
				<h3 class='inputlabel'>
					Template
				</h3>
				<textarea class='template inputtext'>
				</textarea>
			</div>
			<div class='jsondiv'>
				<h3 class='inputlabel'>
					Result
				</h3>
				<textarea class='results inputtext' disabled="true">
				</textarea>
			</div>
		</div>
		<div class='btn-div'>
			<button class='tsv-btn'>Data</button>
			<button class='update-btn'>Update</button>
		</div>
		<textarea class='tsv'>
		</textarea>
	</div>
</template>
<script>
const emptyExample = document.querySelector('#emptyExample')
const renderedBySymbol = {}
examples.forEach(renderExample)

function renderExample(example,i) {
	const clone = document.importNode(emptyExample.content, true)
	const results = clone.querySelector(".results")
	
	// the ParJSON template, not a DOM template
	const template = clone.querySelector(".template")
	template.innerHTML = JSON.stringify(example.template, null, '    ')
	
	const tsv = clone.querySelector(".tsv")
	tsv.innerHTML = tsvText

	const title = clone.querySelector('h4')
	title.innerHTML = example.title
	title.setAttribute("id", example.id)

	const run = getRunFxn({template, tsv, results, title})
	
	const inputLabels = clone.querySelectorAll('.inputlabel')
	for(const label of inputLabels) {
		label.onclick = run
	}

	clone.querySelector('.update-btn').onclick = run

	clone.querySelector('.tsv-btn').onclick = ()=>{
		tsv.style.display = tsv.style.display == "block" ? "none" : "block"
	}

	document.querySelector('#'+example.section).appendChild(clone)
	run()

	if (window.location.hash == '#' + example.id) {
		setTimeout(()=>title.scrollIntoView(), 100)
	}

	if (example.symbol && !renderedBySymbol[example.symbol]) {
		const tab = document.createElement('div')
		tab.setAttribute("class", "nav-symbol")
		tab.innerHTML = example.tabLabel ? example.tabLabel : example.symbol
		const navCol = document.querySelector("#nav-col-" + example.tokenType)
		navCol.appendChild(tab)
		
		tab.onclick = () => {
			collapseSymbols()
			setTimeout(()=>window.location.hash = "#" + example.id, 100)
		}

		navCol.querySelector('.nav-tab').onclick = () => {
			collapseSymbols()
			setTimeout(()=>window.location.hash = "#" + example.section, 100)
		}
	}
}

function getRunFxn(dom) {
	let tracker
	return function() {
		const template = JSON.parse(
			dom.template.value
				.trim()
				.replace("&lt;","<")
				.replace("&gt;",">")
		)

		const data = parseTsv(dom.tsv.value.trim())

		if (tracker) {
			tracker.refresh({
				template,
				data,
			})
		}
		else {
			tracker = new Parjson({
				template,
				data,
				fxns
			})
		}

		dom.results.value = JSON.stringify(tracker.tree, null, "    ")
	}
}

function expandSymbols() {
	document.querySelectorAll(".nav-symbol").forEach(elem => {
		elem.style.height = "16px"
		elem.style.padding = "2px"
	})
}

function collapseSymbols() {
	document.querySelectorAll(".nav-symbol").forEach(elem => {
		elem.style.height = 0
		elem.style.padding = 0
	})
}

function parseTsv(tsv) {
	const data = []
	const lines = tsv.trim().split('\n');
	const header = lines[0].trim().split('\t');
	const tsvParseErrors = []
	lines.forEach((line, i) => {
		if (i===0 || !line) return
		const d = line
			.trim()
			.split('\t')
			.map(_v=>{
				const v = _v.trim()
				return isNumeric(v) ? +v : v
			})
		if (!d.length) {
			tsvParseErrors.push(`Missing line #${i}.`)
			return
		}
		const c = Object.create(null)
		c['line #'] = i 
		header.map((key, j) => c[key]=d[j]);
		c.nested = {random: {id: Math.random().toFixed(3)}}
		c.testObj = {}
		data.push(c)
	}); 
	if (tsvParseErrors.length) {
		console.log('Error parsing tsv: ', tsvParseErrors)
	}
	// console.log(data)
	return data
}

function isNumeric(d) {
	return !isNaN(parseFloat(d)) && isFinite(d) && d!==''
}
</script>
</body>
</html>

