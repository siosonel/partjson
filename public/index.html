<!DOCTYPE html>
<html>
<head>
	<title>Parjson</title>
	<meta charset="utf-8">
	<link rel="shortcut icon" href="">
	<style>
	html {
	  height: 100vh;
	}

	body {
		height: 100vh;
		display: flex;
		flex-direction: column;
  	align-items: stretch;
		font-family: arial, helvetica, sans serif;
	}

	section {
		/*border-bottom: 1px solid #eee;*/
	}


	h1, h3 {
		margin: 0.25rem;
		text-align: center;
	}

	p {
		width: 90%;
		margin: auto;
	}

	.nav-top {
		width: 100%;
    height: 70px;
    z-index: 1;
    overflow: visible;
	}

	.nav-banner {
		padding: 5px;
    background: #333;
    color: #fff;
    overflow: hidden; 
    font-size: 24px;
    font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
	}

	.nav-bar {
		min-height:16px;
    padding: 2px;
    text-align: center;
    background: #333;
    color: #99cc00;
    overflow: hidden;
	}

	.nav-col {
		display: inline-block;
		padding: 5px;
    vertical-align: top;
		text-align: center;
	}

	.nav-tab {
		padding: 2px;
		text-align: center;
    background: #333;
    cursor: pointer;
    font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
    font-size: 12px;
	}

	.nav-symbol {
		height: 0;
		padding: 0;
    width: 100%;
		text-align: center;
    background: #333;
    cursor: pointer;
    overflow: hidden;
    transition: height ease 0.1s, padding ease 0.1s;
    font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
    font-size: 12px;
  }

  .nav-tab:hover, .nav-symbol:hover {
  	color: #ff0;
  	background: #999;
  }

  content {
  	flex: 1;
  }

  .code-snippet {
  	font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
    font-size: 14px;
    color: #990033;
    font-style: normal;
    background: #fff;
  }

	.section-title {
		margin: 30px 0 16px 4%; 
		text-align: left;
	}

	.example-div {
 		width: 90%;
    margin: auto;
    margin-bottom: 40px;
    background: #ececec;
    padding: 10px;
  }

  .example-title {
  	margin: 0 0 0 4%; 
  }

	.jsondiv {
		display: inline-block; 
		height: 20vh;
		width: 45%;
		margin: 10px;
		white-space: nowrap;
	}

	.inputlabel {
		color: #777;
	 	text-decoration: underline; 
	 	font-size: 14px;
	 	cursor: pointer;
	}

	.inputtext {
		width:100%; 
		height:100%;
		border: none;
    background: #333;
    color: #99cc00;
    white-space: pre;
    font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
    font-size: 12px;
    text-align: left;
		overflow: scroll;
	}

	.tsv {
		display: none;
		width: 96%; 
		height: 10vh;
		margin: 0 2%;
    background: #333;
    color: #ff9900;
		white-space: pre;
	}

	.btn-div {
		margin: auto;
		padding: 2px;
		text-align: center;
	}
	</style>
	<script src="test.js"></script>
	<script src="/parjson/src/Parjson.js" charset="utf-8"></script>
	<script src="/parjson/src/KeyFiller.js" charset="utf-8"></script>
	<script src="/parjson/src/ValueFiller.js" charset="utf-8"></script>
	<script src="/parjson/src/Err.js" charset="utf-8"></script>
</head>
<body>

<div class='nav-top'>
	<div class="nav-banner">
		<div style="float:left; padding: 0 12px;">Parjson</div>
	</div>
	<nav class="nav-bar" 
		onmouseleave="collapseSymbols()">
		<div style="width: 100%; min-height: 16px; white-space: nowrap;">
			<div class="nav-col" id="nav-col-skip">
				<div class="nav-tab" onmouseenter="expandSymbols()"> [skip] </div>
			</div>
			<div class="nav-col" id="nav-col-time">
				<div class="nav-tab" onmouseenter="expandSymbols()"> [timing] </div>
			</div>
			<div class="nav-col" id="nav-col-aggr">
				<div class="nav-tab" onmouseenter="expandSymbols()"> [aggregation] </div>
			</div>
			<div class="nav-col" id="nav-col-subs">
				<div class="nav-tab" onmouseenter="expandSymbols()"> [substitution] </div>
			</div>
			<div class="nav-col" id="nav-col-stem">
				<div class="nav-tab" onmouseenter="expandSymbols()">  stem  </div>
			</div>
			<div class="nav-col" id="nav-col-conv">
				<div class="nav-tab" onmouseenter="expandSymbols()"> [conversion] </div>
			</div>
		</div>
	</nav>
</div>

<content>
	<section id='intro'>
		<h3 class='section-title'>Basics</h3>
		<p>
			Parjson fills a JSON-based template for 
			partitioning rows of data into a well-defined tree of 
			shaped data collections and aggregated results. It is
			a data shaping utility that lessens loops and if-else
			branches in code.
		</p>
		<br/>
	</section>

	<section id='quick-examples'>
		<h3 class='section-title'>Quick Examples</h3>
	</section>

	<section id='stem'>
		<h3 class='section-title'>Stem words</h3>
	</section>

	<section id='substitution'>
		<h3 class='section-title'>Substitution</h3>
	</section>

	<section id='conversion'>
		<h3 class='section-title'>Conversion</h3>
	</section>

	<section id='aggregation'>
		<h3 class='section-title'>Aggregation</h3>
	</section>

	<section id='timing'>
		<h3 class='section-title'>Timing</h3>
	</section>

	<section id='skip'>
		<h3 class='section-title'>Skip</h3>
	</section>
</content>

<template id='emptyExample'>
	<div class="example-div">
		<p id="" class="example-title"></p>
		<div style="text-align: center">
			<div class='jsondiv'>
				<h3 class='inputlabel'>
					Template
				</h3>
				<textarea class='template inputtext'>
				</textarea>
			</div>
			<div class='jsondiv'>
				<h3 class='inputlabel'>
					Result
				</h3>
				<textarea class='results inputtext' disabled="true">
				</textarea>
			</div>
		</div>
		<div class='btn-div'>
			<button class='tsv-btn'>TSV</button>
			<button class='update-btn'>Update</button>
		</div>
		<textarea class='tsv'>
		</textarea>
	</div>
</template>
<script>
const emptyExample = document.querySelector('#emptyExample')
const renderedBySymbol = {}
examples.forEach(renderExample)

function renderExample(example,i) {
	const clone = document.importNode(emptyExample.content, true)
	const results = clone.querySelector(".results")
	
	// the ParJSON template, not a DOM template
	const template = clone.querySelector(".template")
	template.value = JSON.stringify(example.template, null, "  ")
	
	const tsv = clone.querySelector(".tsv")
	tsv.value = tsvText

	const title = clone.querySelector('p')
	title.innerHTML = example.title
	title.setAttribute("id", example.id)

	const run = getRunFxn({template, tsv, results, title})
	
	const inputLabels = clone.querySelectorAll('.inputlabel')
	for(const label of inputLabels) {
		label.onclick = run
	}

	clone.querySelector('.update-btn').onclick = run

	clone.querySelector('.tsv-btn').onclick = ()=>{
		tsv.style.display = tsv.style.display == "block" ? "none" : "block"
	}

	document.querySelector('#'+example.section).appendChild(clone)
	run()

	if (window.location.hash == '#' + example.id) {
		setTimeout(()=>title.scrollIntoView(), 100)
	}

	if (example.symbol && !renderedBySymbol[example.symbol]) {
		const tab = document.createElement('div')
		tab.setAttribute("class", "nav-symbol")
		tab.innerHTML = example.tabLabel ? example.tabLabel : example.symbol
		const navCol = document.querySelector("#nav-col-" + example.tokenType)
		navCol.appendChild(tab)
		
		tab.onclick = () => {
			collapseSymbols()
			window.location.hash = "#" + example.id
		}

		navCol.querySelector('.nav-tab').onclick = () => {
			collapseSymbols()
			window.location.hash = "#" + example.section
		}
	}
}

function getRunFxn(dom) {
	let tracker
	return function() {
		const template = JSON.parse(
			dom.template.value
				.trim()
				.replace("&lt;","<")
				.replace("&gt;",">")
		)

		const data = parseTsv(dom.tsv.value.trim())

		if (tracker) {
			tracker.refresh({
				template,
				data,
			})
		}
		else {
			tracker = new Parjson({
				template,
				data,
				fxns
			})
		}

		dom.results.value = JSON.stringify(tracker.tree, null, "  ")
	}
}

function expandSymbols() {
	document.querySelectorAll(".nav-symbol").forEach(elem => {
		elem.style.height = "16px"
		elem.style.padding = "2px"
	})
}

function collapseSymbols() {
	document.querySelectorAll(".nav-symbol").forEach(elem => {
		elem.style.height = 0
		elem.style.padding = 0
	})
}

function parseTsv(tsv) {
	const data = []
	const lines = tsv.trim().split('\n');
	const header = lines[0].trim().split('\t');
	const tsvParseErrors = []
	lines.forEach((line, i) => {
		if (i===0 || !line) return
		const d = line
			.trim()
			.split('\t')
			.map(_v=>{
				const v = _v.trim()
				return isNumeric(v) ? +v : v
			})
		if (!d.length) {
			tsvParseErrors.push(`Missing line #${i}.`)
			return
		}
		const c = Object.create(null)
		c['line #'] = i 
		header.map((key, j) => {
			if (key.endsWith("-json")) {
				c[key.slice(0,-5)] = JSON.parse(d[j])
			}
			else {
				c[key] = d[j]
			}
		});

		c.testObj = {}
		data.push(c)
	}); 
	if (tsvParseErrors.length) {
		console.log('Error parsing tsv: ', tsvParseErrors)
	}
	
	return data
}

function isNumeric(d) {
	return !isNaN(parseFloat(d)) && isFinite(d) && d!==''
}
</script>
</body>
</html>

