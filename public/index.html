<!DOCTYPE html>
<html>
<head>
	<title>Parjson</title>
	<meta charset="utf-8">
	<link rel="shortcut icon" href="">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
	<style>
	html {
	  height: 100vh;
	}

	body {
		height: 100vh;
		display: flex;
		flex-direction: column;
  	align-items: stretch;
		font-family: arial, helvetica, sans serif;
	}

  content {
  	flex: 2;
  	overflow: scroll;
  }

	section {
		/*border-bottom: 1px solid #eee;*/
	}


	h1, h3 {
		margin: 0.25rem;
		text-align: center;
	}

	p, ul {
		width: 90%;
		margin: auto;
	}

	li {
		margin: 5px;
	}

	.nav-top {
		width: 100%;
    height: 70px;
    margin-bottom: 15px;
    z-index: 1;
    overflow: visible;
	}

	.nav-banner {
		padding: 5px;
    background: #333;
    color: #fff;
    overflow: hidden; 
    font-size: 24px;
    font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
	}

	.nav-bar {
		min-height:16px;
    padding: 2px;
    text-align: center;
    background: #333;
    color: #99cc00;
    overflow: hidden;
	}

	.nav-col {
		display: inline-block;
		padding: 5px;
    vertical-align: top;
		text-align: center;
	}

	.nav-tab {
		padding: 2px;
		text-align: center;
    background: #333;
    cursor: pointer;
    font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
    font-size: 12px;
	}

	.nav-symbol {
		height: 0;
		padding: 0;
    width: 100%;
		text-align: center;
    background: #333;
    cursor: pointer;
    overflow: hidden;
    transition: height ease 0.1s, padding ease 0.1s;
    font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
    font-size: 12px;
  }

  .nav-tab:hover, .nav-symbol:hover {
  	color: #ff0;
  	background: #999;
  }

  .code-snippet {
  	font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
    font-size: 14px;
    color: #990033;
    font-style: normal;
    background: #fff;
  }

	.section-title {
		margin: 30px 0 16px 4%; 
		text-align: left;
	}

	.example-div {
		position: relative;
 		width: 90%;
    margin: auto;
    margin-bottom: 40px;
    background: #ececec;
    padding: 10px;
  }

  .example-title {
  	margin: 0 0 0 4%; 
  }

  .example-try {
  	display: none;
  }

  .try-btn {
  	position: absolute;
  	top: 0;
  	right: 0;
    font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
  	font-size: 12px;
  	line-height: 12px;
  	border-style: none;
  	vertical-align: middle;
  	background: #333;
  	color: #99cc00;
  	opacity: 0.75;
  	cursor: pointer;
  }

  .try-btn:hover {
  	opacity: 1;
  }

	.jsondiv {
		display: inline-block; 
		height: 20vh;
		width: 45%;
		margin: 10px;
		white-space: nowrap;
	}

	.inputlabel {
		color: #777;
	 	text-decoration: underline; 
	 	font-size: 14px;
	 	cursor: pointer;
	}

	.inputtext {
		width:100%; 
		height:100%;
		border: none;
    background: #333;
    color: #99cc00;
    white-space: pre;
    font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
    font-size: 12px;
    text-align: left;
		overflow: scroll;
	}

	.tsv {
		display: none;
		width: 94%; 
		height: 10vh;
		margin: 0 3%;
		border: none;
    background: #333;
    color: #ff9900;
		white-space: pre;
    font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
    font-size: 12px;
    text-align: left;
	}

	.fxns {
		display: none;
		width: 94%; 
		height: 10vh;
		margin: 0 3%;
		border: none;
    background: #333;
    color: #fff;
		white-space: pre;
    font-family: Menlo, Monospace, Consolas, Arial, sans-serif;
    font-size: 12px;
    font-weight: 300;
    text-align: left;
    overflow: scroll;
	}

	.fxn-keyword {
		color: #13a4d8;
	}

	.fxn-name {
		color: #99cc00;
	}

	.fxn-arg {
		color: #ff9900;
	}

	.fxn-return {
		color: #d82323;
	}

	.btn-div {
		margin: auto;
		padding: 2px;
		text-align: center;
	}

	.parjson-token {
		color: #ff0;  /*#efbf64;*/
	}
	</style>
	<script src="test.js"></script>
	<script src="/parjson/dist/parjson.umd.js" charset="utf-8"></script>
</head>
<body>

<div class='nav-top'>
	<div class="nav-banner">
		<div style="float:left; padding: 0 12px;">Parjson</div>
	</div>
	<nav class="nav-bar" 
		onmouseleave="collapseSymbols()">
		<div style="width: 100%; min-height: 16px; white-space: nowrap;">
			<div class="nav-col" id="nav-col-skip">
				<div class="nav-tab" onmouseenter="expandSymbols()"> [skip] </div>
			</div>
			<div class="nav-col" id="nav-col-time">
				<div class="nav-tab" onmouseenter="expandSymbols()"> [timing] </div>
			</div>
			<div class="nav-col" id="nav-col-aggr">
				<div class="nav-tab" onmouseenter="expandSymbols()"> [aggregation] </div>
			</div>
			<div class="nav-col" id="nav-col-subs">
				<div class="nav-tab" onmouseenter="expandSymbols()"> [substitution] </div>
			</div>
			<div class="nav-col" id="nav-col-stem">
				<div class="nav-tab" onmouseenter="expandSymbols()">  stem  </div>
			</div>
			<div class="nav-col" id="nav-col-conv">
				<div class="nav-tab" onmouseenter="expandSymbols()"> [conversion] </div>
			</div>
			<div class="nav-col" id="nav-col-reserved">
				<div class="nav-tab" onmouseenter="expandSymbols()"> reserved </div>
			</div>
		</div>
	</nav>
</div>

<content>
	<section id='intro'>
		<h3 class='section-title'>Basics</h3>
		<p>
			Parjson fills a JSON-based template for 
			partitioning rows of data into a well-defined tree of 
			data collections and aggregated results. 
    </p>
	</section>

	<section id='quick-examples'>
		<h3 class='section-title'>Quick Examples</h3>
		<p>Click the <button class='try-btn' style='position:relative'>try</button> button in 
		the upper right corner of the examples below.</p>
		<br/>
	</section>

	<section id='stem'>
		<h3 class='section-title'>Stem words</h3>
	</section>

	<section id='substitution'>
		<h3 class='section-title'>Substitution</h3>
	</section>

	<section id='conversion'>
		<h3 class='section-title'>Conversion</h3>
		<p>A function will be passed the following arguments in order:</p>
		<ul>
			<li><span class="code-snippet">row</span>: 
				the current data row, or <span class='code-snippet'>null</span> when called post-loop</li>
			<li><span class="code-snippet">context</span>: 
			 the <a href='#reserved-context'>context</a> of the current result object being processed</li>
		</ul>
		<p>When used as an input key term, a function
	  must return an array of string <span class='code-snippet'>key</span> values,
	  or an empty array if the filler is to ignore the input for the current data row.  
	  As an input value term, it must return the value for the result[key] input that is 
	  being filled.  
	  </p>
	  <br/>
	</section>

	<section id='aggregation'>
		<h3 class='section-title'>Aggregation</h3>
	</section>

	<section id='timing'>
		<h3 class='section-title'>Timing</h3>
	</section>

	<section id='skip'>
		<h3 class='section-title'>Skip</h3>
	</section>

	<section id='reserved'>
		<h3 class='section-title'>Reserved Terms</h3>
	</section>
</content>

<template id='emptyExample'>
	<div id="" class="example-div">
		<button class="try-btn">try</button>
		<p class="example-title"></p>
		<div class="example-try">
			<div style="text-align: center">
				<div class='jsondiv'>
					<h3 class='inputlabel'>
						Template
					</h3>
					<pre class='template inputtext' contenteditable="true">
					</pre>
				</div>
				<div class='jsondiv'>
					<h3 class='inputlabel'>
						Result
					</h3>
					<pre class='results inputtext' disabled="true">
					</pre>
				</div>
			</div>
			<div class='btn-div'>
				<button class='tsv-btn'>Data</button>
				<button class='update-btn'>Update</button>
				<button class='fxns-btn' style="display:none">Functions</button>
			</div>
			<code class='fxns'>
			</code>
			<textarea class='tsv'>
			</textarea>
		</div>
	</div>
</template>
<script>
const emptyExample = document.querySelector('#emptyExample')
const renderedBySymbol = {}
examples.forEach(renderExample)

function renderExample(example,i) {
	const clone = document.importNode(emptyExample.content, true)
	clone.querySelector('.example-div').setAttribute("id", example.id)
	const results = clone.querySelector(".results")
	const fxns = clone.querySelector(".fxns")
	
	// the ParJSON template, not a DOM template
	const template = clone.querySelector(".template")
	template.innerHTML = highlightTokens(example.template)
	
	const tsv = clone.querySelector(".tsv")
	tsv.innerHTML = tsvText

	const title = clone.querySelector('p')
	title.innerHTML = example.title
	
  const tryDiv = clone.querySelector(".example-try")
	clone.querySelector(".try-btn").onclick = () => {
		const display = tryDiv.style.display != "block" ? "block" : "none"
		tryDiv.style.display = display
		if (display == "none") return
		const fxnStr = run()
		displayFxns(fxnStr, example)
	}

	const run = getRunFxn({template, tsv, results, title})
	
	const inputLabels = clone.querySelectorAll('.inputlabel')
	for(const label of inputLabels) {
		label.onclick = run
	}

	clone.querySelector('.update-btn').onclick = run

	clone.querySelector('.tsv-btn').onclick = ()=>{
		tsv.style.display = tsv.style.display == "block" ? "none" : "block"
		fxns.style.display = "none"
	}

	document.querySelector('#'+example.section).appendChild(clone)

	if (window.location.hash == '#' + example.id) {
		setTimeout(()=>title.scrollIntoView(), 100)
	}

	if (example.symbol && !renderedBySymbol[example.symbol]) {
		const tab = document.createElement('div')
		tab.setAttribute("class", "nav-symbol")
		tab.innerHTML = example.tabLabel ? example.tabLabel : example.symbol
		const navCol = document.querySelector("#nav-col-" + example.tokenType)
		navCol.appendChild(tab)
		
		tab.onclick = () => {
			collapseSymbols()
			//window.location.hash = "#" + example.id
			document.querySelector('#'+example.id).scrollIntoView()
		}

		navCol.querySelector('.nav-tab').onclick = () => {
			collapseSymbols()
			//window.location.hash = "#" + example.section
			document.querySelector('#'+example.section).scrollIntoView()
		}
	}
}

function getRunFxn(dom) {
	let tracker
	return function() {
		const template = JSON.parse(
			dom.template.innerText
				.trim()
				.replace("&lt;","<")
				.replace("&gt;",">")
		)

		const data = parseTsv(dom.tsv.value.trim())

		if (tracker) {
			tracker.refresh({
				template,
				data,
			})
		}
		else {
			tracker = new Parjson({
				template,
				data,
				fxns
			})
		}

		dom.results.innerHTML = JSON.stringify(tracker.tree, null, "  ")

		const fxnStr = {}
		for(const templateFiller of tracker.fillers) {
			const [template, filler] = templateFiller
			for(const term in filler.inputs) {
				if (term[0]=="=") {
					const fxnName = term.slice(1,-2)
					if (!fxnStr[fxnName] && tracker.opts.fxns[fxnName]) {
						fxnStr[fxnName] = tracker.opts.fxns[fxnName].toString()
					}
				}
				const templateVal = filler.inputs[term].templateVal
				if (typeof templateVal == "string" && templateVal[0] == "=") {
					const fxnName = templateVal.slice(1,-2)
					if (!fxnStr[fxnName] && tracker.opts.fxns[fxnName]) {
						fxnStr[fxnName] = tracker.opts.fxns[fxnName].toString()
					}
				}
			}
		}
		return fxnStr
	}
}

function highlightTokens(str) {
	return JSON.stringify(str, null, "  ")
	.replace(/\"\</g, "\"&lt;")
	.replace(/\"\>/g, "\"&gt;")
	.replace(/\"\&lt\;\$/g, "\"<span class='parjson-token'>&lt;$</span>")
	.replace(/\"\&gt\;\$/g, "\"<span class='parjson-token'>&gt;$</span>")
	.replace(/\"\&lt\;/g, "\"<span class='parjson-token'>&lt;</span>")
	.replace(/\"\&gt\;/g, "\"<span class='parjson-token'>&gt;</span>")
	.replace(/\"\=/g, "\"<span class='parjson-token'>=</span>")
	.replace(/\"\$/g, "\"<span class='parjson-token'>$</span>")
	.replace(/\"\+\$/g, "\"<span class='parjson-token'>+$</span>")
	.replace(/\"\-\$/g, "\"<span class='parjson-token'>-$</span>")
	.replace(/\"\&/g, "\"<span class='parjson-token'>&</span>")
	.replace(/\"\@/g, "\"<span class='parjson-token'>@</span>")
	.replace(/\"\+/g, "\"<span class='parjson-token'>+</span>")
	.replace(/\"\-/g, "\"<span class='parjson-token'>-</span>")
	.replace(/\(\)\"/g, "<span class='parjson-token'>()</span>\"")
	.replace(/\[\]\"/g, "<span class='parjson-token'>[]</span>\"")
	.replace(/\:\ \[\n/g, ": <span class='parjson-token'>[</span>\n")
	.replace(/\ \]\n/g, "<span class='parjson-token'>]</span>\n")
	.replace(/\ \]\,\n/g, "<span class='parjson-token'>]</span>,\n")
	.replace(/\"\#/g, "<span class='parjson-token'>\"#</span>")
}

function displayFxns(fxnStr, example) {
	if (!Object.keys(fxnStr).length) return
	const node = document.querySelector('#'+example.id).parentNode
	let str = ""
	for(const fxnName in fxnStr) {
		str += "<i class='fxn-keyword'>function&nbsp;</i>"
				+ fxnStr[fxnName]
					.replace(fxnName, "<span class='fxn-name'>"+ fxnName + "</span>")
					.replace(/row/g, "<span class='fxn-arg'>row</span>")
					.replace(/context/g, "<span class='fxn-arg'>context</span>") 
					.replace(/return\ /g, "<span class='fxn-return'>return </span>")
			  +  "\n\n"
	}

	node.querySelector(".fxns").innerHTML = str //JSON.stringify(fxnStr)
	node.querySelector(".fxns-btn").style.display = "inline"
	node.querySelector(".fxns-btn").onclick = ()=>{
		const currDisplay = node.querySelector(".fxns").style.display
		node.querySelector(".fxns").style.display = currDisplay != "block" ? "block" : "none"
		node.querySelector(".tsv").style.display = "none"
	}
}

function expandSymbols() {
	document.querySelectorAll(".nav-symbol").forEach(elem => {
		elem.style.height = "16px"
		elem.style.padding = "2px"
	})
}

function collapseSymbols() {
	document.querySelectorAll(".nav-symbol").forEach(elem => {
		elem.style.height = 0
		elem.style.padding = 0
	})
}

function parseTsv(tsv) {
	const data = []
	const lines = tsv.trim().split('\n');
	const header = lines[0].trim().split('\t');
	const tsvParseErrors = []
	lines.forEach((line, i) => {
		if (i===0 || !line) return
		const d = line
			.trim()
			.split('\t')
			.map(_v=>{
				const v = _v.trim()
				return isNumeric(v) ? +v : v
			})
		if (!d.length) {
			tsvParseErrors.push(`Missing line #${i}.`)
			return
		}
		const c = Object.create(null)
		c['line #'] = i 
		header.map((key, j) => {
			if (key.endsWith("-json")) {
				c[key.slice(0,-5)] = JSON.parse(d[j])
			}
			else {
				c[key] = d[j]
			}
		});

		c.testObj = {}
		data.push(c)
	}); 
	if (tsvParseErrors.length) {
		console.log('Error parsing tsv: ', tsvParseErrors)
	}
	
	return data
}

function isNumeric(d) {
	return !isNaN(parseFloat(d)) && isFinite(d) && d!==''
}
</script>
</body>
</html>

