<!DOCTYPE html>
<html>
<head>
	<title>Parjson</title>
	<meta charset="utf-8">
	<link rel="shortcut icon" href="">
	<style>
	body {
		font-family: arial, helvetica, sans serif;
		height: 100vh;
	}

	h1, h3 {
		margin: 0.25rem;
		text-align: center;
	}

	.jsondiv {
		display: inline-block; 
		height: 20vh;
		width: 45%;
		margin: 10px;
	}

	.inputlabel {
		color: #777;
	 	text-decoration: underline; 
	 	cursor: pointer;
	}

	.inputtext {
		width:100%; 
		height:100%;
	}

	.tsv {
		width: 92%; 
		height: 10vh;
		margin: 0 4%;
	}
	</style>
	<script src="test.js"></script>
	<script src="/parjson/public/example.js" charset="utf-8"></script>
	<script src="/parjson/src/Parjson.js" charset="utf-8"></script>
	<script src="/parjson/src/KeyFiller.js" charset="utf-8"></script>
	<script src="/parjson/src/ValueFiller.js" charset="utf-8"></script>
	<script src="/parjson/src/Err.js" charset="utf-8"></script>
</head>
<body>
<h1>Parjson</h1>
<template id='emptyExample'>
	<div style='width:100%;'>
		<h4 id="#" style='margin: 50px 0 0 5%'></h4>
		<div style="text-align: center">
			<div class='jsondiv'>
				<h3 class='inputlabel'>
					Template
				</h3>
				<textarea class='template inputtext'>
				</textarea>
			</div>
			<div class='jsondiv'>
				<h3 class='inputlabel'>
					Result
				</h3>
				<textarea class='results inputtext' disabled="true">
				</textarea>
			</div>
		</div>
		<textarea class='tsv'>
		</textarea>
	</div>
</template>
<script>
const emptyExample = document.querySelector('#emptyExample')
examples.forEach(renderExample)

function renderExample(example,i) {
	const clone = document.importNode(emptyExample.content, true)
	const results = clone.querySelector(".results")
	
	// the ParJSON template, not a DOM template
	const template = clone.querySelector(".template")
	template.innerHTML = JSON.stringify(example.template, null, '    ')
	
	const tsv = clone.querySelector(".tsv")
	tsv.innerHTML = tsvText

	const title = clone.querySelector('h4')
	title.innerHTML = example.title
	
	const attr = document.createAttribute("my_attrib")
	title.setAttribute("id", "example-"+i)

	document.body.appendChild(clone)

	const run = getRunFxn({template, tsv, results})
	const inputLabels = document.querySelectorAll('.inputlabel') 
	for(const label of inputLabels) {
		label.onclick = run
	}
	run()
}

function getRunFxn(dom) {
	let tracker
	return () => {
		const template = JSON.parse(
			dom.template.value
				.trim()
				.replace("&lt;","<")
				.replace("&gt;",">")
		)

		const data = parseTsv(dom.tsv.value.trim())

		if (tracker) {
			tracker.refresh({
				template,
				data,
			})
		}
		else {
			tracker = new Parjson({
				template,
				data,
				fxns: {}
			})
		}

		dom.results.value = JSON.stringify(tracker.tree, null, "    ")
	}
}

function parseTsv(tsv) {
	const data = []
	const lines = tsv.trim().split('\n');
	const header = lines[0].trim().split('\t');
	const tsvParseErrors = []
	lines.forEach((line, i) => {
		if (i===0 || !line) return
		const d = line
			.trim()
			.split('\t')
			.map(_v=>{
				const v = _v.trim()
				return isNumeric(v) ? +v : v
			})
		if (!d.length) {
			tsvParseErrors.push(`Missing line #${i}.`)
			return
		}
		const c = Object.create(null)
		c['line #'] = i 
		header.map((key, j) => c[key]=d[j]);
		c.nested = {random: {id: Math.random().toFixed(3)}}
		c.owners = c.owners.split(',')
		c.testObj = {}
		data.push(c)
	}); 
	if (tsvParseErrors.length) {
		console.log('Error parsing tsv: ', tsvParseErrors)
	}
	// console.log(data)
	return data
}

function isNumeric(d) {
	return !isNaN(parseFloat(d)) && isFinite(d) && d!==''
}
</script>
</body>
</html>

