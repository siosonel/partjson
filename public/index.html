<!DOCTYPE html>
<html>
<head>
	<title>Parjson</title>
	<meta charset="utf-8">
	<link rel="shortcut icon" href="">
	<style>
	body {
		font-family: arial, helvetica, sans serif;
		height: 100vh;
	}

	h1, h3 {
		margin: 0.25rem;
		text-align: center;
	}

	.nav-bar {
    background: #555;
    color: #fff;
    padding: 5px;
	}

	.nav-col {
		display: inline-block;
		padding: 5px;
    vertical-align: top;
		text-align: center;
	}

	.nav-tab {
		text-align: center;
	}

	.no-ht {
	 	height: 0;
	 	opacity: 0;
	}

	.section-title {
		margin: 30px 0 16px 4%; 
		text-align: left;
	}

	.example-div {
 		width: 90%;
    margin: auto;
    margin-bottom: 40px;
    background: #ececec;
    padding: 10px;
  }

  .example-title {
  	margin: 0 0 0 4%; 
  	font-style: italic;
  }

	.jsondiv {
		display: inline-block; 
		height: 20vh;
		width: 45%;
		margin: 10px;
		white-space: nowrap;
	}

	.inputlabel {
		color: #777;
	 	text-decoration: underline; 
	 	cursor: pointer;
	}

	.inputtext {
		width:100%; 
		height:100%;
    background: #555;
    color: #fff;
	}

	.tsv {
		width: 92%; 
		height: 10vh;
		margin: 0 4%;
    background: #555;
    color: #fff;
		white-space: nowrap;
	}
	</style>
	<script src="test.js"></script>
	<script src="/parjson/public/example.js" charset="utf-8"></script>
	<script src="/parjson/src/Parjson.js" charset="utf-8"></script>
	<script src="/parjson/src/KeyFiller.js" charset="utf-8"></script>
	<script src="/parjson/src/ValueFiller.js" charset="utf-8"></script>
	<script src="/parjson/src/Err.js" charset="utf-8"></script>
</head>
<body>

<div class="nav-bar" style="height:20px">
	<div style="float:left; padding: 0 12px; font-size: 24px;">ParJSON</div>
	<div style="float:right; height: 16px">
		<div class="nav-col">
			<div class="nav-tab"> [ skip ] </div>
			<div class="nav-tab no-ht"> # </div>
		</div>
		<div class="nav-col">
			<div class="nav-tab"> [ timing ] </div>
			<div class="nav-tab no-ht" style="font-weight: 600"> :__ </div>
			<div class="nav-tab no-ht" style="font-weight: 600"> _:_ </div>
			<div class="nav-tab no-ht" style="font-weight: 600"> __: </div>
		</div>
		<div class="nav-col">
			<div class="nav-tab"> [ aggregation ] </div>
			<div class="nav-tab no-ht" style="font-weight: 600"> + </div>
			<div class="nav-tab no-ht" style="font-weight: 600"> - </div>
			<div class="nav-tab no-ht"> &lt; </div>
			<div class="nav-tab no-ht"> &gt; </div>
			<div class="nav-tab no-ht"> [ &nbsp; ] </div>
		</div>
		<div class="nav-col">
			<div class="nav-tab"> [ substitution ] </div>
			<div class="nav-tab no-ht"> $ </div>
			<div class="nav-tab no-ht"> = </div>
			<div class="nav-tab no-ht"> & </div>
			<div class="nav-tab no-ht"> @ </div>
		</div>
		<div class="nav-col">
			<div class="nav-tab">  stem  </div>
			<div class="nav-tab no-ht"> [ delim ] </div>
		</div>
		<div class="nav-col">
			<div class="nav-tab"> [ conversion ] </div>
			<div class="nav-tab no-ht"> () </div>
			<div class="nav-tab no-ht"> [] </div>
		</div>
	</div>
</div>

<div class="nav-bar" style="height: 95px;">
	<div style="float:right; height: 16px">
		<div class="nav-col">
			<div class="nav-tab no-ht"> [ skip ] </div>
			<div class="nav-tab"> # </div>
		</div>
		<div class="nav-col">
			<div class="nav-tab no-ht"> [ timing ] </div>
			<div class="nav-tab" style="font-weight: 600"> :__ </div>
			<div class="nav-tab" style="font-weight: 600"> _:_ </div>
			<div class="nav-tab" style="font-weight: 600"> __: </div>
		</div>
		<div class="nav-col">
			<div class="nav-tab no-ht"> [ aggregation ] </div>
			<div class="nav-tab" style="font-weight: 600"> + </div>
			<div class="nav-tab" style="font-weight: 600"> - </div>
			<div class="nav-tab"> &lt; </div>
			<div class="nav-tab"> &gt; </div>
			<div class="nav-tab"> [ &nbsp; ] </div>
		</div>
		<div class="nav-col">
			<div class="nav-tab no-ht"> [ substitution ] </div>
			<div class="nav-tab"> $ </div>
			<div class="nav-tab"> = </div>
			<div class="nav-tab"> & </div>
			<div class="nav-tab"> @ </div>
		</div>
		<div class="nav-col">
			<div class="nav-tab no-ht">  stem  </div>
			<div class="nav-tab"> [ delim ] </div>
		</div>
		<div class="nav-col">
			<div class="nav-tab no-ht"> [ conversion ] </div>
			<div class="nav-tab"> ( ) </div>
			<div class="nav-tab"> [ ] </div>
		</div>
	</div>
</div>

<div id='quick-examples'>
	<h3 class='section-title'>Quick Examples</h3>
</div>
<hr>

<div id='substitution'>
	<h3 class='section-title'>Substitution</h3>
</div>
<hr>


<template id='emptyExample'>
	<div class="example-div">
		<h4 id="" class="example-title"></h4>
		<div style="text-align: center">
			<div class='jsondiv'>
				<h3 class='inputlabel'>
					Template
				</h3>
				<textarea class='template inputtext'>
				</textarea>
			</div>
			<div class='jsondiv'>
				<h3 class='inputlabel'>
					Result
				</h3>
				<textarea class='results inputtext' disabled="true">
				</textarea>
			</div>
		</div>
		<textarea class='tsv'>
		</textarea>
	</div>
</template>
<script>
const emptyExample = document.querySelector('#emptyExample')
examples.forEach(renderExample)


function renderExample(example,i) {
	const clone = document.importNode(emptyExample.content, true)
	const results = clone.querySelector(".results")
	
	// the ParJSON template, not a DOM template
	const template = clone.querySelector(".template")
	template.innerHTML = JSON.stringify(example.template, null, '    ')
	
	const tsv = clone.querySelector(".tsv")
	tsv.innerHTML = tsvText

	const title = clone.querySelector('h4')
	title.innerHTML = example.title
	
	const attr = document.createAttribute("my_attrib")
	title.setAttribute("id", example.id)

	document.querySelector('#'+example.section).appendChild(clone)

	const run = getRunFxn({template, tsv, results, title})
	const inputLabels = document.querySelectorAll('.inputlabel') 
	for(const label of inputLabels) {
		label.onclick = run
	}
	run()
	if (window.location.hash == '#' + example.id) {
		setTimeout(()=>title.scrollIntoView(), 100)
	}
}

function getRunFxn(dom) {
	let tracker
	return () => {
		const template = JSON.parse(
			dom.template.value
				.trim()
				.replace("&lt;","<")
				.replace("&gt;",">")
		)

		const data = parseTsv(dom.tsv.value.trim())

		if (tracker) {
			tracker.refresh({
				template,
				data,
			})
		}
		else {
			tracker = new Parjson({
				template,
				data,
				fxns
			})
		}

		dom.results.value = JSON.stringify(tracker.tree, null, "    ")
	}
}

function parseTsv(tsv) {
	const data = []
	const lines = tsv.trim().split('\n');
	const header = lines[0].trim().split('\t');
	const tsvParseErrors = []
	lines.forEach((line, i) => {
		if (i===0 || !line) return
		const d = line
			.trim()
			.split('\t')
			.map(_v=>{
				const v = _v.trim()
				return isNumeric(v) ? +v : v
			})
		if (!d.length) {
			tsvParseErrors.push(`Missing line #${i}.`)
			return
		}
		const c = Object.create(null)
		c['line #'] = i 
		header.map((key, j) => c[key]=d[j]);
		c.nested = {random: {id: Math.random().toFixed(3)}}
		c.testObj = {}
		data.push(c)
	}); 
	if (tsvParseErrors.length) {
		console.log('Error parsing tsv: ', tsvParseErrors)
	}
	// console.log(data)
	return data
}

function isNumeric(d) {
	return !isNaN(parseFloat(d)) && isFinite(d) && d!==''
}
</script>
</body>
</html>

