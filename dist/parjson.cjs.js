"use strict";class KeyFiller{constructor(e){this.Tree=e,this.ignoredVals=e.opts.ignoredVals,this.allowedKeyTypes=new Set(["string","number","undefined"])}getFxn(e,t,s){if(!this.Tree.reservedOpts.includes(e))if(s.keyTokens.skip)this["#"](e,s);else{if(s.keyTokens.subs in this.Tree.valueFiller){const t=this.Tree.valueFiller[s.keyTokens.subs](e,s);if(!t)return void s.errors.push(["key","UNSUPPORTED-KEY-SUBSTITUTION"]);const r=s.keyTokens.conv?s.keyTokens.conv:"''";return this[r]?this[r](t,s):void s.errors.push(["key","UNSUPPORTED-KEY-CONVERSION"])}if(t in this)return this[t](e,s);s.errors.push(["key","UNSUPPORTED-KEY-SYMBOL"])}}getAllowedKeys(e,t,s,r){if(!Array.isArray(e))return r.errors.push(["key","ERR-NON-ARRAY-KEYS",t]),[];const i=[];for(const l of e)this.ignoredVals.includes(l)||(this.allowedKeyTypes.has(typeof l)?i.push(l):r.errors.push([s,"INVALID-RESULT-KEY",t]));return i}}KeyFiller.prototype["''"]=function(e,t){return(s,r)=>this.getAllowedKeys([e(s,r)],s,t,r)},KeyFiller.prototype["()"]=function(e,t){return(s,r)=>this.getAllowedKeys([e(s,r)],s,t,r)},KeyFiller.prototype["[]"]=function(e,t){return(s,r)=>this.getAllowedKeys(e(s,r),s,t,r)},KeyFiller.prototype["#"]=function(e,t){this.Tree.commentedTerms.has(t)||this.Tree.commentedTerms.set(t,{keys:new Set,values:new Set}),this.Tree.commentedTerms.get(t).keys.add(e)};class ValueFiller{constructor(e){this.Tree=e,this.ignoredVals=this.Tree.opts.ignoredVals}getFxn(e,t){return"string"==typeof e.templateVal?this.getStringFiller(e,t):Array.isArray(e.templateVal)?this.getArrayFiller(e,t):e.templateVal&&"object"==typeof e.templateVal?this.getObjectFiller(e):(t,s,r)=>{r[s]=e.templateVal}}getStringFiller(e,t){const[s,r,i]=this.Tree.parseTerm(e.templateVal),l=s+i.conv;e.ignoredVals=l in t?t[l]:t["@"];const o=i.skip?r:i.subs;if(o in this){const t=this[o](s,e);if(t){const s=i.conv?i.conv:"''";return this[i.aggr+s]?this[i.aggr+s](t,e):null}}else e.errors.push(["val","UNSUPPORTED-TEMPLATE-VALUE-SYMBOL"])}getArrayFiller(e,t){if(!e.templateVal[0])return(t,s,r)=>{r[s]=e.templateVal};if("string"==typeof e.templateVal[0]){const[s,r,i]=this.Tree.parseTerm(e.templateVal[0]),l=s+i.conv;e.ignoredVals=l in t?t[l]:t["@"];const o=i.skip?r:i.subs;if(o in this){const t=this[o](s,e);if(t){return this["["+(i.conv?i.conv:"''")+"]"](t,e)}}else e.errors.push(["val","UNSUPPORTED-TEMPLATE-VALUE-SYMBOL"])}else{if(Array.isArray(e.templateVal[0]))return this["[[,]]"](e.templateVal[0],e);if(e.templateVal[0]&&"object"==typeof e.templateVal[0])return this["[{}]"](e.templateVal[0],e);e.errors.push("val","UNSUPPORTED-TEMPLATE-VALUE")}}getObjectFiller(e){return this.Tree.parseTemplate(e.templateVal,e.inheritedIgnored,e.lineage),(t,s,r)=>{s in r||(r[s]=this.Tree.getEmptyResult(s,r));this.Tree.contexts.get(r[s]);this.Tree.processRow(t,e.templateVal,r[s])}}isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)&&""!==e}}ValueFiller.prototype["#"]=function(e,t){this.Tree.commentedTerms.has(t)||this.Tree.commentedTerms.set(t,{keys:new Set,values:new Set}),this.Tree.commentedTerms.get(t).values.add(e)},ValueFiller.prototype[""]=function(e,t){return this.isNumeric(e)?()=>+e:()=>e},ValueFiller.prototype.$=function(e,t){if("$"==e||e=="$"+this.Tree.userDelimit)return e=>e;if(e.includes(this.Tree.userDelimit)){const t=e.slice(1).split(this.Tree.userDelimit);""==t[0]&&t.shift();const s=(e,t)=>e?e[t]:null;return e=>t.reduce(s,e)}{const t=e.slice(1);return e=>e[t]}},ValueFiller.prototype["="]=function(e,t){const s=e.slice(1).split(this.Tree.treeDelimit).reduce((e,t)=>e&&t in e?e[t]:null,this.Tree.opts["="]);if(s)return s;t.errors.push(["val","ERR-MISSING-FXN"])},ValueFiller.prototype["@"]=function(e,t){if(!this.Tree.reservedOpts.includes(e)){if("@"==e||e=="@"+this.Tree.treeDelimit)return(e,t)=>t.self;if(e.includes(this.Tree.treeDelimit)){const t=e.split(this.Tree.treeDelimit),s=(e,t)=>{const[s,r]=e;return s&&t?"@"==t?[r.self,r]:"@"==t[0]?[r[t.slice(1)],this.Tree.contexts.get(r[t.slice(1)])]:s?[s[t],this.Tree.contexts.get(s[t])]:[null,null]:null};return(e,r)=>t.reduce(s,[r.self,r])[0]}{const t=e.slice(1);return(e,s)=>s[t]}}},ValueFiller.prototype["&"]=function(e,t){const s=e.slice(1).split(this.Tree.userDelimit),r=s.shift();if(s.length){if(1==s.length){const e=s[0];return()=>{const t=this.Tree.joins.get(r);return t?t[e]:null}}{const e=(e,t)=>e?e[t]:null;this.Tree.joins.get(r);return t=>s.reduce(e,this.Tree.joins.get(r))}}return()=>this.Tree.joins.get(r)},ValueFiller.prototype["''"]=function(e,t){return(s,r,i,l)=>{const o=e(s,l);t.ignoredVals(o,r,s)||(i[r]=o)}},ValueFiller.prototype["()"]=ValueFiller.prototype["''"],ValueFiller.prototype["[]"]=ValueFiller.prototype["''"],ValueFiller.prototype["['']"]=function(e,t){const s=t.templateVal[1]?t.templateVal[1]:"";return s&&"distinct"==s?(s,r,i,l)=>{r in i||(i[r]=new Set);const o=e(s,l);t.ignoredVals(o,r,s,l)||i[r].add(o)}:(s,r,i,l)=>{r in i||(i[r]=[]);const o=e(s,l);t.ignoredVals(o,r,s,l)||i[r].push(o)}},ValueFiller.prototype["[()]"]=ValueFiller.prototype["['']"],ValueFiller.prototype["[[]]"]=function(e,t){const s=t.templateVal[1]?t.templateVal[1]:"";return s&&"distinct"==s?(s,r,i,l)=>{const o=e(s,l);if(Array.isArray(o)){r in i||(i[r]=new Set);for(const e of o){if(t.ignoredVals(e,r,s,l))return;i[r].add(e)}}else l.errors.push([t,"ERR-NON-ARRAY-VALS",s])}:(s,r,i,l)=>{const o=e(s,l);if(Array.isArray(o)){r in i||(i[r]=[]);for(const e of o){if(t.ignoredVals(e,r,s,l))return;i[r].push(...o)}}else l.errors.push([t,"ERR-NON-ARRAY-VALS",s])}},ValueFiller.prototype["[{}]"]=function(e,t){this.Tree.parseTemplate(e,t.inheritedIgnored,t.lineage);this.Tree.fillers.get(e);return(t,s,r)=>{s in r||(r[s]=this.Tree.getEmptyResult(s,r,!0));const i=this.Tree.getEmptyResult(r[s].length,r);this.Tree.processRow(t,e,i),r[s].push(i)}},ValueFiller.prototype["[[,]]"]=function(e,t){const s=[];for(const r of e){const e=Object.assign({},t,{templateVal:r});s.push(this.getFxn(e,t.inheritedIgnored))}const r=t.templateVal[1]?t.templateVal[1]:"";return r&&"map"==r?(e,t,r)=>{t in r||(r[t]=new Map);const i=[];s[0](e,0,i),r[t].has(i[0])&&(i[1]=r[t].get(i[0])),s[1](e,1,i),r[t].set(i[0],i[1])}:(e,t,r)=>{t in r||(r[t]=[]);const i=[];for(const t in s)s[+t](e,+t,i);r[t].push(i)}},ValueFiller.prototype["+''"]=function(e,t){return(s,r,i,l)=>{r in i||(i[r]=0);const o=e(s,l);t.ignoredVals(o,r,s,l)||(i[r]+=o)}},ValueFiller.prototype["+()"]=ValueFiller.prototype["+''"],ValueFiller.prototype["-''"]=function(e,t){return(s,r,i,l)=>{r in i||(i[r]=0);const o=e(s,l);t.ignoredVals(o,r,s,l)||(i[r]-=o)}},ValueFiller.prototype["-()"]=ValueFiller.prototype["-''"],ValueFiller.prototype["<''"]=function(e,t){return(s,r,i,l)=>{const o=+e(s,l);t.ignoredVals(o,r,s,l)||(this.isNumeric(o)?r in i?i[r]<o&&(i[r]=o):i[r]=o:l.errors.push([t,"NON-NUMERIC-THAN",s]))}},ValueFiller.prototype["<()"]=ValueFiller.prototype["<''"],ValueFiller.prototype[">''"]=function(e,t){return(s,r,i,l)=>{const o=+e(s,l);t.ignoredVals(o,r,s,l)||(this.isNumeric(o)?r in i?i[r]>o&&(i[r]=o):i[r]=o:l.errors.push([t,"NON-NUMERIC-THAN",s]))}},ValueFiller.prototype[">()"]=ValueFiller.prototype[">''"];class Err{constructor(){this.errors=new Set,this.resultLog=Object.create(null),this.quiet=!1}clear(){this.errors.clear(),this.resultLog=Object.create(null)}log(e){Object.keys(this.resultLog).length&&console.log(this.resultLog)}markErrors(e,t){if(!t)return;const s=this.resultLog;for(const r in t.filler.inputs){const i=t.filler.inputs[r];for(const t of i.errors){const[r,l,o]=t;l in s||(s[l]=Object.create(null));const n=JSON.stringify(i.lineage);n in s[l]||(s[l][n]=o?[]:0),o?s[l][n].push(o):s[l][n]+=1,"key"==r?e["{{ "+l+" }} "+i.term]=i.templateVal:"val"==r&&(Array.isArray(i.templateVal)?e[i.term]=["{{ "+l+" }} ",...i.templateVal]:"string"==typeof i.templateVal?e[i.term]="{{ "+l+" }} "+i.templateVal:e[i.term]="{{ "+l+" }} ")}}if(t.errors.length){const s={};e["@errors"]=s;for(const e of t.errors){const[t,r,i]=e,l="{{ "+r+" }} "+t.term;l in s||(s[l]=0),s[l]+=1}}if(t.filler.errors.length){e["@errors"]||(e["@errors"]={});for(const s of t.filler.errors){const t=s[1];t in e["@errors"]||(e["@errors"][t]=[]),e["@errors"][t].push(s.slice(2))}}}}class Parjson{constructor(e={}){this.defaultOpts={template:{},"=":{},ignoredVals:[]},this.opts=Object.assign(this.defaultOpts,e),this.userDelimit=".",this.treeDelimit=".",this.subsSymbols=["$","=","@","&"],this.convSymbols=["()","[]"],this.aggrSymbols=["+","-","<",">"],this.timeSymbols=[":__","_:_","__:"],this.skipSymbols=["#"],this.reservedOpts=["@userDelimit","@treeDelimit"],this.reservedFxns=["@before()","@after()","@dist()","@join()"],this.reservedContexts=["@branch","@parent","@root","@self"],this.reservedTerms=[...this.reservedOpts,...this.reservedFxns,...this.reservedContexts],this.steps=[":__","","_:_"],this.errors=new Err(this),this.keyFiller=new KeyFiller(this),this.valueFiller=new ValueFiller(this),this.refresh()}refresh(e={}){this.errors.clear(),Object.assign(this.opts,e),this.opts.template["@userDelimit"]&&(this.userDelimit=this.opts.template["@userDelimit"]),this.opts.template["@treeDelimit"]&&(this.treeDelimit=this.opts.template["@treeDelimit"]),delete this.commentedTerms,this.commentedTerms=new WeakMap,delete this.joins,this.joins=new Map,delete this.fillers,this.fillers=new Map,delete this.context,this.contexts=new WeakMap,delete this.tree,this.tree=this.getEmptyResult(),this.parseTemplate(this.opts.template,{"@":this.falseFxn}),this.opts.data&&this.add(this.opts.data,!1),this.errors.log(this.fillers)}parseTemplate(e,t,s=[]){const r=Object.create(null);r.inputs=Object.create(null),r["@before"]=this.trueFxn,r["@after"]=this.trueFxn,r["__:"]=[],r.errors=[];const i=this["@ignoredVals"](e,t,r);r["@ignoredVals"]=i,this.fillers.set(e,r);const l=this.steps.map(e=>[]);for(const t in e){const[o,n,a,u]=this.parseTerm(t),p=e[t],c=r.inputs[t]={term:t,subterm:o,symbols:n,keyTokens:a,templateVal:p,lineage:[...s,t],inheritedIgnored:i,errors:[]};"@()"==n?this[o]?r[o]=this[o](e[t],c,r):c.errors.push("key","UNRECOGNIZED-RESERVED-"+t):(c.keyFxn=this.keyFiller.getFxn(o,n,c),c.keyFxn&&(c.valFxn=this.valueFiller.getFxn(c,i),"__:"==a.time?r["__:"].push(t):l[u].push(t)))}r.steps=l.filter(e=>e.length)}parseTerm(e){const t=this.skipSymbols.includes(e[0])?"#":"",s=e.slice(0,3),r=this.timeSymbols.includes(s)?s:"",i=t.length+r.length,l=e[i],o=e.slice(-2),n=this.aggrSymbols.includes(l)?l:"",a=this.convSymbols.includes(o)?o:"",u=n&&a?e.slice(i+1,-2):n?e.slice(i+1):a?e.slice(i,-2):r?e.slice(i):e,p=this.subsSymbols.includes(u[0])?u[0]:"",c=t||n+p+a,h=p?u.slice(1):u;return[u,c,{skip:t,time:r,aggr:n,subs:p,stem:h,conv:a,subterm:u},this.steps.indexOf(r)]}getEmptyResult(e=null,t=null,s=!1){const r=s?[]:Object.create(null),i={branch:e,parent:t,self:r,root:this.tree?this.tree:r,errors:[]};return this.contexts.set(r,i),r}add(e,t=!0){t&&error.clear(),this.joins.clear();for(const t of e)this.processRow(t,this.opts.template,this.tree),this.joins.clear();this.processResult(this.tree),t&&this.errors.log()}processRow(e,t,s){const r=this.contexts.get(s),i=this.fillers.get(t);if(r.filler=i,i["@before"](e,s,r)&&(!i["@join"]||i["@join"](e))){for(const t of i.steps)for(const l of t){const t=i.inputs[l];if(t.keyFxn&&t.valFxn){const i=t.keyFxn(e,r);for(const l of i)t.valFxn&&t.valFxn(e,l,s,r)}}i["@after"](e,s,r),i["@dist"]&&i["@dist"](r),i["@done"]&&(r.done=i["@done"])}}processResult(e){const t=this.contexts.get(e);if(t)for(const s of t.filler["__:"]){const r=t.filler.inputs[s];if(r.keyFxn&&r.valFxn){const s=r.keyFxn(null,t);for(const i of s)r.valFxn&&r.valFxn(null,i,e,t)}}for(const t in e){e[t]instanceof Set?e[t]=[...e[t]]:e[t]instanceof Map&&(e[t]=[...e[t].entries()]);const s=e[t];if(s)if(Array.isArray(s)){if(s[0]&&"object"==typeof s[0])for(const e of s)this.processResult(e)}else if("object"==typeof s){const e=this.contexts.get(s);e&&e["@dist"]&&e["@dist"](s),this.processResult(s)}}this.errors.markErrors(e,t),t&&t.done&&t.done(e)}trueFxn(){return!0}falseFxn(){return!1}isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)&&""!==e}}Parjson.prototype["@before"]=function(e,t){const s=this.opts["="][e.slice(1,-2)];return s||(t.errors.push(["val","MISSING-@before-FXN"]),this.trueFxn)},Parjson.prototype["@after"]=function(e,t){const s=this.opts["="][e.slice(1,-2)];return s||(t.errors.push(["val","MISSING-@after-FXN"]),this.trueFxn)},Parjson.prototype["@join"]=function(e,t,s){return s=>{let r=!0;for(const i in e){const l=this.opts["="][e[i].slice(1,-2)];if(l){const e=l(s);e?this.joins.set(i,e):r=!1}else t.errors.push(["val","MISSING-@join-FXN"])}return r}},Parjson.prototype["@dist"]=function(e,t){const s=Array.isArray(e)?e[0]:e,r=this.valueFiller["@"](s);return e=>{e["@dist"]=(i=>{const l=r(null,e);l?Array.isArray(l)?l.push(i):l[s]=i:e.errors.push([t,"MISSING-DIST-TARGET"])})}},Parjson.prototype["@done"]=function(e,t){const s=this.opts["="][e.slice(1,-2)];return s||(t.errors.push(["val","MISSING-@before-FXN"]),this.trueFxn)},Parjson.prototype["@ignoredVals"]=function(e,t,s){if(!e["@ignoredVals()"])return t;const r=Array.isArray(e["@ignoredVals()"])||"string"==typeof e["@ignoredVals()"],i=r?{"@":e["@ignoredVals()"]}:e["@ignoredVals()"],l={};for(const e in i){const t=i[e];if(Array.isArray(t))l[e]=(e=>t.includes(e));else if("string"==typeof t&&"="==t[0]){const r=this.opts["="][t.slice(1,-2)];r?l[e]=r:(s.errors.push(["val","MISSING-@ignoredVals()-FXN",t]),l[e]=this.falseFxn)}else s.errors.push(["val","UNSUPPORTED-@ignoredVals()-VALUE",t]),l[e]=this.falseFxn}return r?l:Object.assign({},t,l)},window.Parjson=Parjson,module.exports=Parjson;
