class e{constructor(e){this.Tree=e,this.ignoredVals=e.opts.ignoredVals,this.allowedKeyTypes=new Set(["string","number","undefined"])}getFxn(e,t,s){if(!this.Tree.reservedOpts.includes(e))if(s.keyTokens.skip)this["#"](e,s);else{if(s.keyTokens.subs in this.Tree.valueFiller){const t=this.Tree.valueFiller[s.keyTokens.subs](e,s);if(!t)return void s.errors.push(["key","UNSUPPORTED-KEY-SUBSTITUTION"]);const r=s.keyTokens.conv?s.keyTokens.conv:"''";return this[r]?this[r](t,s):void s.errors.push(["key","UNSUPPORTED-KEY-CONVERSION"])}if(t in this)return this[t](e,s);s.errors.push(["key","UNSUPPORTED-KEY-SYMBOL"])}}getAllowedKeys(e,t,s,r){if(!Array.isArray(e))return r.errors.push(["key","ERR-NON-ARRAY-KEYS",t]),[];const i=[];for(const o of e)this.ignoredVals.includes(o)||(this.allowedKeyTypes.has(typeof o)?i.push(o):r.errors.push([s,"INVALID-RESULT-KEY",t]));return i}}e.prototype["''"]=function(e,t){return(s,r)=>this.getAllowedKeys([e(s,r)],s,t,r)},e.prototype["()"]=function(e,t){return(s,r)=>this.getAllowedKeys([e(s,r)],s,t,r)},e.prototype["[]"]=function(e,t){return(s,r)=>this.getAllowedKeys(e(s,r),s,t,r)},e.prototype["#"]=function(e,t){this.Tree.commentedTerms.has(t)||this.Tree.commentedTerms.set(t,{keys:new Set,values:new Set}),this.Tree.commentedTerms.get(t).keys.add(e)};class t{constructor(e){this.Tree=e,this.ignoredVals=this.Tree.opts.ignoredVals}getFxn(e){return"string"==typeof e.templateVal?this.getStringFiller(e):Array.isArray(e.templateVal)?this.getArrayFiller(e):e.templateVal&&"object"==typeof e.templateVal?this.getObjectFiller(e):(t,s,r)=>{r[s]=e.templateVal}}getStringFiller(e){const[t,s,r]=this.Tree.parseTerm(e.templateVal),i=r.skip?s:r.subs;if(i in this){const s=this[i](t,e);if(s){const t=r.conv?r.conv:"''";return this[r.aggr+t]?this[r.aggr+t](s,e):null}}else e.errors.push(["val","UNSUPPORTED-TEMPLATE-VALUE-SYMBOL"])}getArrayFiller(e){if(!e.templateVal[0])return(t,s,r)=>{r[s]=e.templateVal};if("string"==typeof e.templateVal[0]){const[t,s,r]=this.Tree.parseTerm(e.templateVal[0]),i=r.skip?s:r.subs;if(i in this){const s=this[i](t,e);if(s){return this["["+(r.conv?r.conv:"''")+"]"](s,e)}}else e.errors.push(["val","UNSUPPORTED-TEMPLATE-VALUE-SYMBOL"])}else{if(Array.isArray(e.templateVal[0]))return this["[[,]]"](e.templateVal[0],e);if(e.templateVal[0]&&"object"==typeof e.templateVal[0])return this["[{}]"](e.templateVal[0],e);e.errors.push("val","UNSUPPORTED-TEMPLATE-VALUE")}}getObjectFiller(e){return this.Tree.parseTemplate(e.templateVal,e.inheritedIgnored,e.lineage),(t,s,r)=>{s in r||(r[s]=this.Tree.getEmptyResult(s,r));this.Tree.contexts.get(r[s]);this.Tree.processRow(t,e.templateVal,r[s])}}isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)&&""!==e}}t.prototype["#"]=function(e,t){this.Tree.commentedTerms.has(t)||this.Tree.commentedTerms.set(t,{keys:new Set,values:new Set}),this.Tree.commentedTerms.get(t).values.add(e)},t.prototype[""]=function(e,t){return this.isNumeric(e)?()=>+e:()=>e},t.prototype.$=function(e,t){if("$"==e||e=="$"+this.Tree.userDelimit)return e=>e;if(e.includes(this.Tree.userDelimit)){const t=e.slice(1).split(this.Tree.userDelimit);""==t[0]&&t.shift();const s=(e,t)=>e?e[t]:null;return e=>t.reduce(s,e)}{const t=e.slice(1);return e=>e[t]}},t.prototype["="]=function(e,t){const s=e.slice(1).split(this.Tree.treeDelimit).reduce((e,t)=>e&&t in e?e[t]:null,this.Tree.opts["="]);if(s)return s;t.errors.push(["val","ERR-MISSING-FXN"])},t.prototype["@"]=function(e,t){if(!this.Tree.reservedOpts.includes(e)){if("@"==e||e=="@"+this.Tree.treeDelimit)return(e,t)=>t.self;if(e.includes(this.Tree.treeDelimit)){const t=e.split(this.Tree.treeDelimit),s=(e,t)=>{const[s,r]=e;return s&&t?"@"==t?[r.self,r]:"@"==t[0]?[r[t.slice(1)],this.Tree.contexts.get(r[t.slice(1)])]:s?[s[t],this.Tree.contexts.get(s[t])]:[null,null]:null};return(e,r)=>t.reduce(s,[r.self,r])[0]}{const t=e.slice(1);return(e,s)=>s[t]}}},t.prototype["&"]=function(e,t){const s=e.slice(1).split(this.Tree.userDelimit),r=s.shift();if(s.length){if(1==s.length){const e=s[0];return()=>{const t=this.Tree.joins.get(r);return t?t[e]:null}}{const e=(e,t)=>e?e[t]:null;this.Tree.joins.get(r);return t=>s.reduce(e,this.Tree.joins.get(r))}}return()=>this.Tree.joins.get(r)},t.prototype["''"]=function(e,t){return(s,r,i,o)=>{const n=e(s,o);t.ignoredVals(n,r,s)||(i[r]=n)}},t.prototype["()"]=t.prototype["''"],t.prototype["[]"]=t.prototype["''"],t.prototype["['']"]=function(e,t){const s=t.templateVal[1]?t.templateVal[1]:"";return s&&"distinct"==s?(s,r,i,o)=>{r in i||(i[r]=new Set);const n=e(s,o);t.ignoredVals(n,r,s,o)||i[r].add(n)}:(s,r,i,o)=>{r in i||(i[r]=[]);const n=e(s,o);t.ignoredVals(n,r,s,o)||i[r].push(n)}},t.prototype["[()]"]=t.prototype["['']"],t.prototype["[[]]"]=function(e,t){const s=t.templateVal[1]?t.templateVal[1]:"";return s&&"distinct"==s?(s,r,i,o)=>{const n=e(s,o);if(Array.isArray(n)){r in i||(i[r]=new Set);for(const e of n){if(t.ignoredVals(e,r,s,o))return;i[r].add(e)}}else o.errors.push([t,"ERR-NON-ARRAY-VALS",s])}:(s,r,i,o)=>{const n=e(s,o);if(Array.isArray(n)){r in i||(i[r]=[]);for(const e of n){if(t.ignoredVals(e,r,s,o))return;i[r].push(...n)}}else o.errors.push([t,"ERR-NON-ARRAY-VALS",s])}},t.prototype["[{}]"]=function(e,t){this.Tree.parseTemplate(e,t.inheritedIgnored,t.lineage);this.Tree.fillers.get(e);return(t,s,r)=>{s in r||(r[s]=this.Tree.getEmptyResult(s,r,!0));const i=this.Tree.getEmptyResult(r[s].length,r);this.Tree.processRow(t,e,i),r[s].push(i)}},t.prototype["[[,]]"]=function(e,t){const s=[];for(const r of e){const e=Object.assign({},t,{templateVal:r});s.push(this.getFxn(e))}const r=t.templateVal[1]?t.templateVal[1]:"";return r&&"map"==r?(e,t,r)=>{t in r||(r[t]=new Map);const i=[];s[0](e,0,i),r[t].has(i[0])&&(i[1]=r[t].get(i[0])),s[1](e,1,i),r[t].set(i[0],i[1])}:(e,t,r)=>{t in r||(r[t]=[]);const i=[];for(const t in s)s[+t](e,+t,i);r[t].push(i)}},t.prototype["+''"]=function(e,t){return(s,r,i,o)=>{r in i||(i[r]=0);const n=e(s,o);t.ignoredVals(n,r,s,o)||(i[r]+=n)}},t.prototype["+()"]=t.prototype["+''"],t.prototype["-''"]=function(e,t){return(s,r,i,o)=>{r in i||(i[r]=0);const n=e(s,o);t.ignoredVals(n,r,s,o)||(i[r]-=n)}},t.prototype["-()"]=t.prototype["-''"],t.prototype["<''"]=function(e,t){return(s,r,i,o)=>{const n=+e(s,o);t.ignoredVals(n,r,s,o)||(this.isNumeric(n)?r in i?i[r]<n&&(i[r]=n):i[r]=n:o.errors.push([t,"NON-NUMERIC-THAN",s]))}},t.prototype["<()"]=t.prototype["<''"],t.prototype[">''"]=function(e,t){return(s,r,i,o)=>{const n=+e(s,o);t.ignoredVals(n,r,s,o)||(this.isNumeric(n)?r in i?i[r]>n&&(i[r]=n):i[r]=n:o.errors.push([t,"NON-NUMERIC-THAN",s]))}},t.prototype[">()"]=t.prototype[">''"];class s{constructor(){this.errors=new Set,this.resultLog=Object.create(null),this.quiet=!1}clear(){this.errors.clear(),this.resultLog=Object.create(null)}log(e){Object.keys(this.resultLog).length&&console.log(this.resultLog)}markErrors(e,t){if(!t)return;const s=this.resultLog;for(const r in t.filler.inputs){const i=t.filler.inputs[r];for(const t of i.errors){const[r,o,n]=t;o in s||(s[o]=Object.create(null));const l=JSON.stringify(i.lineage);l in s[o]||(s[o][l]=n?[]:0),n?s[o][l].push(n):s[o][l]+=1,"key"==r?e["{{ "+o+" }} "+i.term]=i.templateVal:"val"==r&&(Array.isArray(i.templateVal)?e[i.term]=["{{ "+o+" }} ",...i.templateVal]:"string"==typeof i.templateVal?e[i.term]="{{ "+o+" }} "+i.templateVal:e[i.term]="{{ "+o+" }} ")}}if(t.errors.length){const s={};e["@errors"]=s;for(const e of t.errors){const[t,r,i]=e,o="{{ "+r+" }} "+t.term;o in s||(s[o]=0),s[o]+=1}}if(t.filler.errors.length){e["@errors"]||(e["@errors"]={});for(const s of t.filler.errors){const t=s[1];t in e["@errors"]||(e["@errors"][t]=[]),e["@errors"][t].push(s.slice(2))}}}}class r{constructor(r={}){this.defaultOpts={template:{},"=":{},ignoredVals:[]},this.opts=Object.assign(this.defaultOpts,r),this.userDelimit=".",this.treeDelimit=".",this.subsSymbols=["$","=","@","&"],this.convSymbols=["()","[]"],this.aggrSymbols=["+","-","<",">"],this.timeSymbols=[":__","_:_","__:"],this.skipSymbols=["#"],this.reservedOpts=["@userDelimit","@treeDelimit"],this.reservedFxns=["@before()","@after()","@dist()","@join()"],this.reservedContexts=["@branch","@parent","@root","@self"],this.reservedTerms=[...this.reservedOpts,...this.reservedFxns,...this.reservedContexts],this.steps=[":__","","_:_"],this.errors=new s(this),this.keyFiller=new e(this),this.valueFiller=new t(this),this.refresh()}refresh(e={}){this.errors.clear(),Object.assign(this.opts,e),this.opts.template["@userDelimit"]&&(this.userDelimit=this.opts.template["@userDelimit"]),this.opts.template["@treeDelimit"]&&(this.treeDelimit=this.opts.template["@treeDelimit"]),delete this.commentedTerms,this.commentedTerms=new WeakMap,delete this.joins,this.joins=new Map,delete this.fillers,this.fillers=new Map,delete this.context,this.contexts=new WeakMap,delete this.tree,this.tree=this.getEmptyResult(),this.parseTemplate(this.opts.template,{"@":this.falseFxn}),this.opts.data&&this.add(this.opts.data,!1),this.errors.log(this.fillers)}parseTemplate(e,t,s=[]){const r=Object.create(null);r.inputs=Object.create(null),r["@before"]=this.trueFxn,r["@after"]=this.trueFxn,r["__:"]=[],r.errors=[];const i=this["@ignoredVals"](e,t,r);r["@ignoredVals"]=i,this.fillers.set(e,r);const o=this.steps.map(e=>[]);for(const t in e){const[n,l,p,a]=this.parseTerm(t),c=e[t],h=r.inputs[t]={term:t,subterm:n,symbols:l,keyTokens:p,templateVal:c,lineage:[...s,t],ignoredVals:"string"==typeof c&&c in i?i[c]:Array.isArray(c)&&c[0]in i?i[c[0]]:i["@"],inheritedIgnored:i,errors:[]};"@()"==l?this[n]?r[n]=this[n](e[t],h,r):h.errors.push("key","UNRECOGNIZED-RESERVED-"+t):(h.keyFxn=this.keyFiller.getFxn(n,l,h),h.keyFxn&&(h.valFxn=this.valueFiller.getFxn(h),"__:"==p.time?r["__:"].push(t):o[a].push(t)))}r.steps=o.filter(e=>e.length)}parseTerm(e){const t=this.skipSymbols.includes(e[0])?"#":"",s=e.slice(0,3),r=this.timeSymbols.includes(s)?s:"",i=t.length+r.length,o=e[i],n=e.slice(-2),l=this.aggrSymbols.includes(o)?o:"",p=this.convSymbols.includes(n)?n:"",a=l&&p?e.slice(i+1,-2):l?e.slice(i+1):p?e.slice(i,-2):r?e.slice(i):e,c=this.subsSymbols.includes(a[0])?a[0]:"",h=t||l+c+p,u=c?a.slice(1):a;return[a,h,{skip:t,time:r,aggr:l,subs:c,stem:u,conv:p,subterm:a},this.steps.indexOf(r)]}getEmptyResult(e=null,t=null,s=!1){const r=s?[]:Object.create(null),i={branch:e,parent:t,self:r,root:this.tree?this.tree:r,errors:[]};return this.contexts.set(r,i),r}add(e,t=!0){t&&error.clear(),this.joins.clear();for(const t of e)this.processRow(t,this.opts.template,this.tree),this.joins.clear();this.processResult(this.tree),t&&this.errors.log()}processRow(e,t,s){const r=this.contexts.get(s),i=this.fillers.get(t);if(r.filler=i,i["@before"](e,s,r)&&(!i["@join"]||i["@join"](e))){for(const t of i.steps)for(const o of t){const t=i.inputs[o];if(t.keyFxn&&t.valFxn){const i=t.keyFxn(e,r);for(const o of i)t.valFxn&&t.valFxn(e,o,s,r)}}i["@after"](e,s,r),i["@dist"]&&i["@dist"](r)}}processResult(e){const t=this.contexts.get(e);if(t)for(const s of t.filler["__:"]){const r=t.filler.inputs[s];if(r.keyFxn&&r.valFxn){const s=r.keyFxn(null,t);for(const i of s)r.valFxn&&r.valFxn(null,i,e,t)}}for(const t in e){e[t]instanceof Set?e[t]=[...e[t]]:e[t]instanceof Map&&(e[t]=[...e[t].entries()]);const s=e[t];if(s)if(Array.isArray(s)){if(s[0]&&"object"==typeof s[0])for(const e of s)this.processResult(e)}else if("object"==typeof s){const e=this.contexts.get(s);e&&e["@dist"]&&e["@dist"](s),this.processResult(s)}}this.errors.markErrors(e,t)}trueFxn(){return!0}falseFxn(){return!1}isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)&&""!==e}}r.prototype["@ignoredVals"]=function(e,t,s){if(!e["@ignoredVals()"])return t;const r=Array.isArray(e["@ignoredVals()"])||"string"==typeof e["@ignoredVals()"],i=r?{"@":e["@ignoredVals()"]}:e["@ignoredVals()"],o={};for(const e in i){const t=i[e];if(Array.isArray(t))o[e]=(e=>t.includes(e));else if("string"==typeof t&&"="==t[0]){const r=this.opts["="][t.slice(1,-2)];r?o[e]=r:(s.errors.push(["val","MISSING-@ignoredVals()-FXN",t]),o[e]=this.falseFxn)}else s.errors.push(["val","UNSUPPORTED-@ignoredVals()-VALUE",t]),o[e]=this.falseFxn}return r?o:Object.assign({},t,o)},r.prototype["@before"]=function(e,t){const s=this.opts["="][e.slice(1,-2)];return s||(t.errors.push(["val","MISSING-@before-FXN"]),this.trueFxn)},r.prototype["@after"]=function(e,t){const s=this.opts["="][e.slice(1,-2)];return s||(t.errors.push(["val","MISSING-@after-FXN"]),this.trueFxn)},r.prototype["@join"]=function(e,t,s){return s=>{let r=!0;for(const i in e){const o=this.opts["="][e[i].slice(1,-2)];if(o){const e=o(s);e?this.joins.set(i,e):r=!1}else t.errors.push(["val","MISSING-@join-FXN"])}return r}},r.prototype["@dist"]=function(e,t){const s=Array.isArray(e)?e[0]:e,r=this.valueFiller["@"](s);return e=>{e["@dist"]=(i=>{const o=r(null,e);o?Array.isArray(o)?o.push(i):o[s]=i:e.errors.push([t,"MISSING-DIST-TARGET"])})}};export default r;
